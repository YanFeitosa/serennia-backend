// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ENUMS

enum PlatformRole {
  super_admin
  tenant_admin
}

enum SalonStatus {
  pending
  active
  suspended
}

enum UserRole {
  manager
  receptionist
  professional
}

enum CollaboratorStatus {
  active
  inactive
}

enum AppointmentStatus {
  pending
  in_progress
  completed
  canceled
  no_show
  not_paid
}

enum AppointmentOrigin {
  whatsapp
  app
  totem
  reception
}

enum OrderStatus {
  open
  closed
  paid
}

enum OrderItemType {
  service
  product
}

enum PaymentMethod {
  cash
  card
  pix
  online
}

enum PaymentStatus {
  pending
  confirmed
  failed
}

enum NotificationType {
  info
  warning
  error
}

enum CategoryType {
  service
  product
}

enum AuditAction {
  INSERT
  UPDATE
  DELETE
}

enum CommissionMode {
  service
  professional
}

enum MessageChannel {
  whatsapp
  sms
  email
}

enum MessageStatus {
  pending
  sent
  failed
}

/// MODELS

model Salon {
  id            String      @id @default(uuid())
  name          String
  document      String?
  defaultCommissionRate Decimal        @default(0.5)
  commissionMode       CommissionMode @default(professional)
  fixedCostsMonthly   Decimal?
  variableCostRate     Decimal?
  rolePermissions      Json?
  theme                Json?
  stockControlEnabled  Boolean   @default(true)
  tenantAdminId String?     @unique
  status        SalonStatus @default(pending)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // WhatsApp Integration
  whatsappApiUrl      String?
  whatsappApiKey      String?
  whatsappInstanceId  String?
  whatsappPhone       String?
  whatsappConnected   Boolean   @default(false)

  // Payment Integration
  paymentProvider       String?
  mpAccessToken         String?
  mpPublicKey           String?
  stripeSecretKey       String?
  stripePublishableKey  String?

  tenantAdmin   User?       @relation("SalonTenantAdmin", fields: [tenantAdminId], references: [id])
  users         User[]
  clients       Client[]
  collaborators Collaborator[]
  services      Service[]
  products      Product[]
  categories    Category[]
  appointments  Appointment[]
  orders        Order[]
  payments      Payment[]
  commissionRecords CommissionRecord[]
  commissionPayments CommissionPayment[]
  expenses      Expense[]
  auditLogs     AuditLog[]
  notifications Notification[]
  orderItems    OrderItem[]
  messageTemplates MessageTemplate[]
  messageLogs   MessageLog[]
}

model User {
  id           String        @id @default(uuid())
  salonId      String?
  name         String
  email        String
  passwordHash String?       // Optional - not used when using Supabase Auth
  phone        String?
  platformRole PlatformRole?
  tenantRole   UserRole?
  avatarUrl    String?
  deletedAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  salon            Salon?         @relation(fields: [salonId], references: [id])
  tenantAdminSalon Salon?         @relation("SalonTenantAdmin")
  collaborator     Collaborator?
  notifications    Notification[]
  auditLogs        AuditLog[]
  paymentsReceived Payment[]       @relation("PaymentsReceivedByUser")
  ordersCreated    Order[]        @relation("OrdersCreatedByUser")

  @@unique([salonId, email])
  @@index([platformRole])
  @@index([salonId, platformRole])
  @@index([deletedAt])
}

model Client {
  id        String    @id @default(uuid())
  salonId   String
  name      String
  phone     String
  email     String?
  lastVisit DateTime?
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  salon        Salon         @relation(fields: [salonId], references: [id])
  appointments Appointment[]
  orders       Order[]
  messageLogs  MessageLog[]

  @@unique([salonId, phone])
  @@index([deletedAt])
}

model Collaborator {
  id                String             @id @default(uuid())
  salonId           String
  userId            String?            @unique
  name              String
  role              UserRole
  status            CollaboratorStatus
  phone             String?
  email             String?
  cpf               String?
  commissionRate    Decimal
  serviceCategories String[]
  avatarUrl         String?
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Campos para sistema de comissões
  commissionMode    CommissionMode     @default(service) // service = usa comissão do serviço, professional = usa taxa do profissional
  // Informações bancárias para pagamento de comissões
  pixKey            String?
  pixKeyType        String?            // cpf, cnpj, email, phone, random
  bankName          String?
  bankAgency        String?
  bankAccount       String?
  bankAccountType   String?            // corrente, poupanca
  // Endereço (útil para RPA/folha)
  address           String?
  addressNumber     String?
  addressComplement String?
  addressNeighborhood String?
  addressCity       String?
  addressState      String?
  addressZipCode    String?
  // Data de admissão/nascimento
  hireDate          DateTime?
  birthDate         DateTime?

  salon Salon @relation(fields: [salonId], references: [id])
  user  User? @relation(fields: [userId], references: [id])

  appointments      Appointment[]
  orderItems        OrderItem[]
  commissionRecords CommissionRecord[]
  commissionPayments CommissionPayment[]

  @@unique([salonId, phone])
  @@unique([salonId, email])
  @@unique([salonId, cpf])
  @@index([deletedAt])
}

model Category {
  id        String       @id @default(uuid())
  salonId   String
  type      CategoryType
  name      String
  isActive  Boolean      @default(true)
  deletedAt DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  salon    Salon     @relation(fields: [salonId], references: [id])
  services Service[] @relation("ServiceCategory")
  products Product[] @relation("ProductCategory")

  @@unique([salonId, type, name])
  @@index([deletedAt])
}

model Service {
  id          String   @id @default(uuid())
  salonId     String
  name        String
  categoryId  String?
  description String?
  duration    Int
  price       Decimal
  commission  Decimal?
  isActive    Boolean  @default(true)
  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  salon        Salon                @relation(fields: [salonId], references: [id])
  category     Category?            @relation("ServiceCategory", fields: [categoryId], references: [id])
  appointments AppointmentService[]
  orderItems   OrderItem[]

  @@index([deletedAt])
}

model Product {
  id          String   @id @default(uuid())
  salonId     String
  name        String
  categoryId  String?
  description String?
  price       Decimal
  costPrice   Decimal?
  stock       Int
  trackStock  Boolean  @default(true)
  isActive    Boolean  @default(true)
  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  salon      Salon       @relation(fields: [salonId], references: [id])
  category   Category?   @relation("ProductCategory", fields: [categoryId], references: [id])
  orderItems OrderItem[]

  @@index([deletedAt])
}

model Appointment {
  id             String            @id @default(uuid())
  salonId        String
  clientId       String
  collaboratorId String
  start          DateTime
  end            DateTime
  status         AppointmentStatus
  origin         AppointmentOrigin
  notes          String?
  orderId        String?           @unique
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  salon        Salon        @relation(fields: [salonId], references: [id])
  client       Client       @relation(fields: [clientId], references: [id])
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id])

  services AppointmentService[]
  order    Order?               @relation("AppointmentToOrder", fields: [orderId], references: [id])
  messageLogs MessageLog[]
}

model AppointmentService {
  appointmentId String
  serviceId     String

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  service     Service     @relation(fields: [serviceId], references: [id])

  @@id([appointmentId, serviceId])
}

model Order {
  id              String      @id @default(uuid())
  salonId         String
  clientId        String
  status          OrderStatus @default(open)
  finalValue      Decimal
  createdAt       DateTime    @default(now())
  closedAt        DateTime?
  createdByUserId String?
  updatedAt       DateTime?

  salon     Salon  @relation(fields: [salonId], references: [id])
  client    Client @relation(fields: [clientId], references: [id])
  createdBy User?  @relation("OrdersCreatedByUser", fields: [createdByUserId], references: [id])

  appointment       Appointment?       @relation("AppointmentToOrder")
  items             OrderItem[]
  payments          Payment[]
  commissionRecords CommissionRecord[]
}

model OrderItem {
  id             String        @id @default(uuid())
  orderId        String
  salonId        String
  type           OrderItemType
  serviceId      String?
  productId      String?
  collaboratorId String?
  quantity       Int           @default(1)
  price          Decimal
  commission     Decimal
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())

  order        Order         @relation(fields: [orderId], references: [id])
  salon        Salon         @relation(fields: [salonId], references: [id])
  service      Service?      @relation(fields: [serviceId], references: [id])
  product      Product?      @relation(fields: [productId], references: [id])
  collaborator Collaborator? @relation(fields: [collaboratorId], references: [id])

  commissionRecords CommissionRecord[]

  @@index([deletedAt])
}

model Payment {
  id               String        @id @default(uuid())
  orderId          String
  salonId          String
  method           PaymentMethod
  amount           Decimal
  status           PaymentStatus @default(pending)
  transactionDate  DateTime      @default(now())
  receivedByUserId String?

  order      Order @relation(fields: [orderId], references: [id])
  salon      Salon @relation(fields: [salonId], references: [id])
  receivedBy User? @relation("PaymentsReceivedByUser", fields: [receivedByUserId], references: [id])
}

model CommissionRecord {
  id             String    @id @default(uuid())
  salonId        String
  collaboratorId String
  orderId        String
  orderItemId    String?
  amount         Decimal
  paid           Boolean   @default(false)
  paymentDate    DateTime?
  periodStart    DateTime?
  periodEnd      DateTime?

  salon        Salon        @relation(fields: [salonId], references: [id])
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id])
  order        Order        @relation(fields: [orderId], references: [id])
  orderItem    OrderItem?   @relation(fields: [orderItemId], references: [id])
}

model AuditLog {
  id        String      @id @default(uuid())
  salonId   String
  userId    String
  action    AuditAction
  tableName String
  recordId  String
  timestamp DateTime    @default(now())
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?

  salon Salon @relation(fields: [salonId], references: [id])
  user  User  @relation(fields: [userId], references: [id])
}

model Notification {
  id        String            @id @default(uuid())
  userId    String
  salonId   String?
  message   String
  read      Boolean           @default(false)
  createdAt DateTime          @default(now())
  link      String?
  type      NotificationType?

  user  User   @relation(fields: [userId], references: [id])
  salon Salon? @relation(fields: [salonId], references: [id])
}

model MessageTemplate {
  id        String        @id @default(uuid())
  salonId   String
  name      String
  channel   MessageChannel
  content   String
  variables Json?
  isActive  Boolean       @default(true)
  deletedAt DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  salon      Salon        @relation(fields: [salonId], references: [id])
  messageLogs MessageLog[]

  @@unique([salonId, name])
  @@index([deletedAt])
}

model MessageLog {
  id           String        @id @default(uuid())
  salonId      String
  templateId   String?
  appointmentId String?
  clientId     String
  channel      MessageChannel
  content      String
  status       MessageStatus @default(pending)
  sentAt       DateTime?
  errorMessage String?

  salon        Salon            @relation(fields: [salonId], references: [id])
  template     MessageTemplate? @relation(fields: [templateId], references: [id])
  appointment  Appointment?     @relation(fields: [appointmentId], references: [id])
  client       Client           @relation(fields: [clientId], references: [id])

  createdAt    DateTime         @default(now())
}

enum ExpenseType {
  FIXED
  VARIABLE
}

model Expense {
  id        String      @id @default(uuid())
  salonId   String
  name      String
  amount    Decimal
  type      ExpenseType
  isActive  Boolean     @default(true)
  deletedAt DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  salon Salon @relation(fields: [salonId], references: [id])

  @@unique([salonId, name])
  @@index([deletedAt])
}

model CommissionPayment {
  id             String   @id @default(uuid())
  salonId        String
  collaboratorId String
  amount         Decimal
  periodStart    DateTime
  periodEnd      DateTime
  paidAt         DateTime @default(now())
  notes          String?

  salon        Salon        @relation(fields: [salonId], references: [id])
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id])
}
